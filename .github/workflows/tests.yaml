name: Mojo Unit Tests

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev, main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Mojo
        run: |
          python -m pip install --upgrade pip
          pip install mojo==0.26.1
        
      - name: Install system deps for PortAudio/PyAudio
        run: |
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev pulseaudio pulseaudio-utils dbus-x11

      - name: Install Python Dependencies
        run: |
          pip install librosa numpy matplotlib scipy PyAudio

      # - name: Create Librosa Results for Testing Against
      #   run: |
      #     python testing_mmm_audio/validation/librosa_results_for_testing_against.py

      # - name: Run UnitTests.mojo
      #   id: run-tests
      #   run: |
      #     mojo testing_mmm_audio/UnitTests.mojo

      # - name: Test Building Mojo Files
      #   run: |
      #     python testing_mmm_audio/test_build_mojo_files.py
        
      # - name: Validate Against Snapshots
      #   run: |
      #     python testing_mmm_audio/validation/validate_against_snapshot.py
      
      - name: Set up dummy audio devices (PulseAudio null sink)
        run: |
          sudo apt-get update
          sudo apt-get install -y pulseaudio pulseaudio-utils dbus-x11
          eval "$(dbus-launch --sh-syntax)"
          export DBUS_SESSION_BUS_ADDRESS
          pulseaudio --start
          sleep 2
          pactl load-module module-null-sink sink_name=dummy_out sink_properties=device.description="Dummy_Output"
          pactl set-default-sink dummy_out
          DUMMY_SRC=$(pactl list short sources | awk '/dummy_out.monitor/ {print $2}')
          pactl set-default-source "$DUMMY_SRC"
      
      - name: Run Tests Using Dummy Audio Devices
        run: |
          python testing_mmm_audio/py_unit_tests/MessengerRoundTripTest.py